version: 2.1

commands:
  install_golangci-lint:
    description: "Install golangci-lint"
    parameters:
      version:
        type: string
        default: "v1.15.0"
      sudo:
        type: boolean
        default: true
      insecure:
        type: boolean
        default: false
    steps:
      - install_retry:
          sudo: << parameters.sudo >>
          insecure: << parameters.insecure >>
      - run:
          name: "Installing golangci-lint"
          command: |
            command -v golangci-lint ^>/dev/null || (
              cd
              dl --insecure="<< parameters.insecure >>" -o - https://install.goreleaser.com/github.com/golangci/golangci-lint.sh | retry -m 3 sh -s << parameters.version >>
              echo "export PATH=~/bin:$PATH" >> $BASH_ENV
            )
            PATH=${HOME}/bin golangci-lint --version

  install_curl:
    description: "Install curl (if missing)"
    steps:
      - run:
          name: installing curl
          command: |
            command -v curl &>/dev/null || (
              apk add --no-cache curl || (apt update && apt install curl)
            )
            curl --version

  install_retry:
    description: "Install moul.io/retry (if missing)"
    parameters:
      version:
        type: string
        default: "v0.5.0"
      sudo:
        type: boolean
        default: true
      insecure:
        type: boolean
        default: false
    steps:
      - dl/install:
          url: "https://github.com/moul/retry/releases/download/<< parameters.version >>/retry_$(uname -s)_$(uname -m)"
          sudo: << parameters.sudo >>
          insecure: << parameters.insecure >>
          output: retry
      - run: retry --version

  test:
    description: "Internal: testing the orb."
    parameters:
      sudo:
        type: boolean
        default: true
      insecure:
        type: boolean
        default: false
    steps:
      - install_retry:
          sudo: << parameters.sudo >>
          insecure: << parameters.insecure >>
      - run: retry --version
      - install_golangci-lint:
          sudo: << parameters.sudo >>
          insecure: << parameters.insecure >>
      - run: golangci-lint --version

orbs:
  dl: moul/dl@1.6.0

jobs:
  test-circleci-node:
    docker:
      - image: circleci/node
    steps:
      - test
  test-circleci-golang:
    docker:
      - image: circleci/golang
    steps:
      - test
  test-circleci-python:
    docker:
      - image: circleci/python
    steps:
      - test
  test-alpine:
    docker:
      - image: alpine
    steps:
      - test:
          sudo: false
          insecure: true

workflows:
  main:
    jobs:
      - test-circleci-node
      - test-circleci-golang
      - test-circleci-python
      - test-alpine
